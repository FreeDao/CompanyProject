package com.zgan.yckz.activity;

import android.app.AlertDialog;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;

import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.os.Bundle;
import android.os.IBinder;
import android.os.StrictMode;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.CompoundButton;
import android.widget.ImageView;
import android.widget.ProgressBar;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.Toast;

import android.widget.TextView;

import com.zgan.yckz.R;

import com.zgan.yckz.tcp.Frame;
import com.zgan.yckz.tcp.FrameTools;
import com.zgan.yckz.tcp.TCPSend;
import com.zgan.yckz.tcp.TCPTest;

import com.zgan.yckz.tools.SheBei;
import com.zgan.yckz.tools.YCKZ_Activity;
import com.zgan.yckz.tools.YCKZ_NetworkDetector;
import com.zgan.yckz.tools.YCKZ_SQLHelper;
import com.zgan.yckz.tools.YCKZ_Static;

/**
 * 主界面
 * 
 * @author Administrator
 * 
 */
public class Main_Acitivty extends YCKZ_Activity {
	/*
	 * 主界面按钮
	 */
	/**
	 * @param vip
	 *            :VIP积分
	 */
	TextView vip_btn;
	/**
	 * @param more
	 *            :更多应用
	 */
	Button more_btn;

	/**
	 * @param alarm
	 *            :报警记录
	 */
	TextView alarm_btn;
	/**
	 * @param swicth
	 *            :开关详情
	 */
	TextView swicth_btn;
	/**
	 * @param user_info
	 *            ： 用户信息
	 */
	TextView user_info;
	/**
	 * @param shebei_set
	 */
	TextView shebei_set;
	ImageView deng_btn;
	/**
	 * 开关
	 */
	RadioButton keting_btn;
	RadioButton zhuwo_btn;
	RadioButton ciwo_btn;
	RadioButton chazuo_btn;
	RadioButton chufang_btn;
	/**
	 * 设备开关状态0：关 1：开
	 */
	public static int keting_statues;
	public static int zhuwo_statues = 0;
	public static int chazuo_statues = 0;
	public static int chufang_statues = 0;
	public static int ciwo_statues = 0;
	/*
	 * Socket socket; private static final String TAG = "Socket_Android";
	 */
	Intent intent2 = null;

	YCKZ_SQLHelper yckz_SQLHelper;

	SQLiteDatabase db;

	String keting_sta = null;

	String mac = null;

	SharedPreferences preferences;
	String name;
	String pas;

	private String progress;
	private MyBroadcastReceiver myBroadcastReceiver = new MyBroadcastReceiver();
	private ProgressBar progressBar;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main_line);
		if (android.os.Build.VERSION.SDK_INT > 9) {
			StrictMode.ThreadPolicy policy = new StrictMode.ThreadPolicy.Builder()
					.permitAll().build();
			StrictMode.setThreadPolicy(policy);
		}
		yckz_SQLHelper = new YCKZ_SQLHelper(this, "yckz.db3", 1);
		db = yckz_SQLHelper.getReadableDatabase();

		preferences = getSharedPreferences("yckz_user", MODE_PRIVATE);
		// 初始化 主界面按钮

		vip_btn = (TextView) findViewById(R.id.vip);

		alarm_btn = (TextView) findViewById(R.id.alarm_detalis);
		swicth_btn = (TextView) findViewById(R.id.switch_detalis);
		user_info = (TextView) findViewById(R.id.user_info);
		shebei_set = (TextView) findViewById(R.id.shebei_set);
		deng_btn = (ImageView) findViewById(R.id.deng_btn);

		keting_btn = (RadioButton) findViewById(R.id.keting_btn);
		zhuwo_btn = (RadioButton) findViewById(R.id.zhuwo_btn);
		ciwo_btn = (RadioButton) findViewById(R.id.ciwo_btn);
		chazuo_btn = (RadioButton) findViewById(R.id.chazuo_btn);
		chufang_btn = (RadioButton) findViewById(R.id.chufang_btn);

		vip_btn.setOnClickListener(listener);
		user_info.setOnClickListener(listener);
		alarm_btn.setOnClickListener(listener);
		swicth_btn.setOnClickListener(listener);
		shebei_set.setOnClickListener(listener);

		keting_btn.setOnClickListener(listener);
		zhuwo_btn.setOnClickListener(listener);
		ciwo_btn.setOnClickListener(listener);
		chazuo_btn.setOnClickListener(listener);
		chufang_btn.setOnClickListener(listener);
		deng_btn.setOnClickListener(listener);
		StartTCPServer();
		show();

	}

	private void show() {
		// TODO Auto-generated method stub
		Select();

	}

	private void Select() {
		// TODO Auto-generated method stub
		Cursor c = db.rawQuery("select *from table_SubDev where _DeviceName=?",
				new String[] { "智能主开关（一位智能开关）" });
		Log.i("subdevid", "智能主开关（一位智能开关）");
		if (c.moveToFirst()) {
			keting_sta = c.getString(c.getColumnIndex("_JobStatus"));
			Log.i("keting_sta", keting_sta);

			keting_statues = Integer.parseInt(keting_sta.substring(1, 2));
			Log.i("keting_statues", "" + keting_statues);
		}

	}

	private void StartTCPServer() {
		// TODO Auto-generated method stub
		Boolean networkState = YCKZ_NetworkDetector.detect(Main_Acitivty.this);
		if (!networkState) {
			new AlertDialog.Builder(this)
					.setTitle("网络错误")
					.setMessage("网络连接失败，请确认网络连接")
					.setPositiveButton("确定",
							new DialogInterface.OnClickListener() {
								@Override
								public void onClick(DialogInterface arg0,
										int arg1) {
									// TODO Auto-generated method stub
									arg0.dismiss();
								}
							}).show();
		} else {
			intent2 = new Intent(this, TCPTest.class);
			startService(intent2);
		}

	}

	OnClickListener listener = new OnClickListener() {

		@Override
		public void onClick(View v) {
			// TODO Auto-generated method stub
			switch (v.getId()) {
			case R.id.vip:
				Intent intent = new Intent(Main_Acitivty.this, Vip_Info.class);
				startActivity(intent);
				break;

			case R.id.more:
				intent = new Intent(Main_Acitivty.this, More_Acitivity.class);
				startActivity(intent);
				break;

			case R.id.alarm_detalis:
				intent = new Intent(Main_Acitivty.this, Alarm_Activity.class);
				startActivity(intent);

				break;
			case R.id.user_info:
				intent = new Intent(Main_Acitivty.this, UserInfo_Activity.class);
				startActivity(intent);
				break;
			case R.id.shebei_set:
				intent = new Intent(Main_Acitivty.this,
						SheBeiSet_Activity.class);
				startActivity(intent);

				break;
			case R.id.switch_detalis:
				intent = new Intent(Main_Acitivty.this, More_Acitivity.class);
				startActivity(intent);
				break;
			case R.id.zhuwo_btn:
				if (ciwo_btn.isChecked()) {
					ciwo_btn.setChecked(false);
				}
				if (chazuo_btn.isChecked()) {
					chazuo_btn.setChecked(false);
				}
				if (chufang_btn.isChecked()) {
					chufang_btn.setChecked(false);
				}
				if (keting_btn.isChecked()) {
					keting_btn.setChecked(false);
				}
				break;
			case R.id.ciwo_btn:
				if (zhuwo_btn.isChecked()) {
					zhuwo_btn.setChecked(false);
				}
				if (chazuo_btn.isChecked()) {
					chazuo_btn.setChecked(false);
				}
				if (chufang_btn.isChecked()) {
					chufang_btn.setChecked(false);
				}
				if (keting_btn.isChecked()) {
					keting_btn.setChecked(false);
				}
				break;
			case R.id.chufang_btn:
				if (ciwo_btn.isChecked()) {
					ciwo_btn.setChecked(false);
				}
				if (chazuo_btn.isChecked()) {
					chazuo_btn.setChecked(false);
				}
				if (zhuwo_btn.isChecked()) {
					zhuwo_btn.setChecked(false);
				}
				if (keting_btn.isChecked()) {
					keting_btn.setChecked(false);
				}
				break;
			case R.id.chazuo_btn:
				if (ciwo_btn.isChecked()) {
					ciwo_btn.setChecked(false);
				}
				if (chufang_btn.isChecked()) {
					chufang_btn.setChecked(false);
				}
				if (zhuwo_btn.isChecked()) {
					zhuwo_btn.setChecked(false);
				}
				if (keting_btn.isChecked()) {
					keting_btn.setChecked(false);
				}
				break;
			case R.id.keting_btn:
				StartTCPServer();
				if (zhuwo_btn.isChecked()) {
					zhuwo_btn.setChecked(false);
				}
				if (chazuo_btn.isChecked()) {
					chazuo_btn.setChecked(false);
				}
				if (chufang_btn.isChecked()) {
					chufang_btn.setChecked(false);
				}
				if (ciwo_btn.isChecked()) {
					ciwo_btn.setChecked(false);
				}
				if (keting_statues != 1) {
					deng_btn.setImageDrawable(getResources().getDrawable(
							R.drawable.deng_true));

				} else {
					deng_btn.setImageDrawable(getResources().getDrawable(
							R.drawable.deng_flase));
				}

				break;
			case R.id.deng_btn:
				if (keting_btn.isChecked()) {
					name = preferences.getString("user_name", null);
					pas = preferences.getString("user_pas", null);
					if (name != null && !"".equals(name) && pas != null
							&& !"".equals(pas)) {
						if (keting_statues != 1) {
							keting_statues = 1;
							setSwitch();

						} else {
							keting_statues = 0;
							setSwitch();
						}
					} else {
						Toast.makeText(Main_Acitivty.this, "你尚未登陆,请退出程序后重新登陆",
								Toast.LENGTH_SHORT).show();

					}
				}
				break;
			}
		}
	};

	protected void setSwitch() {
		// TODO Auto-generated method stub
		/**
		 * 灯光控制
		 */

		Log.i("灯光控制", "灯光控制");

		Frame f = new Frame();
		Log.i("keting_statues", "" + keting_statues);
		Selectmac();
		String statues = keting_statues + "," + keting_statues;
		f.Platform = 11;
		f.MainCmd = 1;
		f.SubCmd = 0;
		f.strData = mac + "\t" + statues;
		FrameTools.toSendTcpData(f);
	}

	private void Selectmac() {
		// TODO Auto-generated method stub
		Cursor c = db.rawQuery("select *from table_SubDev where _DeviceName=?",
				new String[] { "智能主开关（一位智能开关）" });
		Log.i("subdevid", "智能主开关（一位智能开关）");
		if (c.moveToFirst()) {
			mac = c.getString(c.getColumnIndex("_MAC"));
			Log.i("mac", mac);

		}
	}

	// 定义一个广播接收器
	class MyBroadcastReceiver extends BroadcastReceiver {
		@Override
		public void onReceive(Context context, Intent intent) {
			// TODO Auto-generated method stub
			// 接收到Service发送的广播信息，得到数据，更新UI
			progress = intent.getStringExtra("strData");
			Log.i("progress.length()", "" + progress.length());

			Log.i("AAAAAAAAAAAAAAAAAAAA", "" + progress);
			if (keting_statues != 1) {
				if (!progress.equals("0")) {
					Toast.makeText(Main_Acitivty.this, "操作失败。",
							Toast.LENGTH_SHORT).show();
					keting_statues = 1;

				} else {
					deng_btn.setImageDrawable(getResources().getDrawable(
							R.drawable.deng_true));

				}
			} else {

				if (!progress.equals("0")) {
					Toast.makeText(Main_Acitivty.this, "操作失败。",
							Toast.LENGTH_SHORT).show();
					keting_statues = 0;
				} else {
					deng_btn.setImageDrawable(getResources().getDrawable(
							R.drawable.deng_flase));
				}
			}

		}
	}

	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();
		// 注册广播接收器
		IntentFilter filter = new IntentFilter();
		// 设置接收广播的类型，这里要和Service里设置的类型匹配，还可以在AndroidManifest.xml文件中注册
		filter.addAction("com.zgan.yckz");
		this.registerReceiver(myBroadcastReceiver, filter);

	}

	@Override
	protected void onDestroy() {
		// TODO Auto-generated method stub
		if (intent2 != null) {

			this.stopService(intent2);
		}
		if (db != null) {
			db.close();
		}

		super.onDestroy();
	}

	@Override
	protected void onStop() {
		// TODO Auto-generated method stub
		super.onStop();
		this.unregisterReceiver(myBroadcastReceiver);
	}
}
